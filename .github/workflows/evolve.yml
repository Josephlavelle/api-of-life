name: Daily Evolution

on:
  # schedule:
  #   # Run daily at 2:00 AM UTC
  #   - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode - skip Claude API calls, just test git flow'
        required: false
        default: 'false'
        type: boolean

# Ensure only one evolution runs at a time
concurrency:
  group: evolution
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  evolve:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: src/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          pip install -r src/requirements.txt
          npm install -g @anthropic-ai/claude-code

      - name: Verify Claude CLI
        run: |
          which claude || echo "claude not found in PATH"
          claude --version || echo "claude --version failed"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up environment
        id: setup
        run: |
          echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "time=$(date +%H:%M:%S)" >> $GITHUB_OUTPUT
          mkdir -p evolution/logs

      - name: Phase 1 - Review and suggest feature
        id: review
        if: ${{ inputs.test_mode != true }}
        working-directory: src
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cat << 'EOF' | timeout 120 claude --print --dangerously-skip-permissions -p - | tee /tmp/suggestion.txt
          You are reviewing a FastAPI codebase to suggest ONE new feature to implement.

          IMPORTANT CONSTRAINTS (budget-conscious):
          - Suggest a SMALL, SIMPLE feature (max 50 lines of code changes)
          - Must be implementable in under 5 minutes
          - NO complex features like authentication, databases, external APIs, or caching
          - NO refactoring or architectural changes
          - Think: add a field, add a simple endpoint, add basic validation

          Guidelines for your suggestion:
          - Suggest an incremental, buildable feature that adds genuine value
          - Avoid breaking existing functionality
          - Prefer simple enhancements: new query parameters, additional fields, basic filtering
          - Keep it focused - one clear, small feature

          The codebase has two files: main.py (the API) and tests/test_main.py (the tests).
          Suggest ONE specific small feature.

          Format your response as:
          FEATURE: [Short feature name - max 5 words]
          DESCRIPTION: [1-2 sentences only]
          IMPLEMENTATION: [Brief bullet points of what to change]
          EOF

          # Extract feature name
          FEATURE_NAME=$(grep -m1 "FEATURE:" /tmp/suggestion.txt | sed 's/.*FEATURE:\*\* *//' | sed 's/\*//g' | xargs || echo "New feature")
          echo "feature_name=${FEATURE_NAME}" >> $GITHUB_OUTPUT

      - name: Phase 2 - Implement feature
        if: ${{ inputs.test_mode != true }}
        working-directory: src
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          {
            echo "Implement the following feature:"
            echo ""
            cat /tmp/suggestion.txt
            echo ""
            cat << 'EOF'
          IMPORTANT CONSTRAINTS (budget-conscious):
          - Keep changes MINIMAL - aim for under 50 lines changed
          - ONLY modify main.py and tests/test_main.py in the current directory
          - Do NOT create new files
          - Do NOT install new dependencies
          - Do NOT navigate to parent directories or other folders
          - Add 1-3 tests maximum
          - If the feature seems too complex, implement a simpler version

          Guidelines:
          - Follow the existing code style and patterns
          - Ensure backward compatibility with existing endpoints
          - Keep changes focused on the suggested feature only

          Implement this feature now. Be concise.
          EOF
          } | timeout 300 claude --print --dangerously-skip-permissions --allowedTools "Edit,Read,Grep" -p -

      - name: Test mode - Make dummy change
        id: test_review
        if: ${{ inputs.test_mode == true }}
        run: |
          echo "# Test run at $(date)" >> evolution/history.md
          echo "feature_name=Test commit flow" >> $GITHUB_OUTPUT

      - name: Phase 3 - Run tests
        id: test
        if: ${{ inputs.test_mode != true }}
        working-directory: src
        run: |
          if python -m pytest tests/ -v; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
            echo "::error::Tests failed! Reverting changes."
            git checkout -- .
            exit 1
          fi

      - name: Phase 4 - Commit changes
        id: commit
        env:
          FEATURE_NAME: ${{ inputs.test_mode == true && steps.test_review.outputs.feature_name || steps.review.outputs.feature_name }}
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          if [ "${{ inputs.test_mode }}" == "true" ]; then
            git add evolution/
          else
            git add src/
          fi

          git commit -m "feat: ${FEATURE_NAME}

          Auto-evolved on ${{ steps.setup.outputs.date }} at ${{ steps.setup.outputs.time }}
          
          Triggered by: GitHub Actions"

      - name: Phase 5 - Update history
        if: ${{ steps.commit.outputs.has_changes == 'true' && inputs.test_mode != true }}
        env:
          FEATURE_NAME: ${{ steps.review.outputs.feature_name }}
          DATE: ${{ steps.setup.outputs.date }}
          TIME: ${{ steps.setup.outputs.time }}
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 2>/dev/null || echo "Unknown")

          {
            echo ""
            echo "## ${DATE} - ${FEATURE_NAME}"
            echo ""
            echo "**Time:** ${TIME}"
            echo ""
            echo "**Trigger:** GitHub Actions"
            echo ""
            echo "**Files Changed:**"
            echo "\`\`\`"
            echo "${CHANGED_FILES}"
            echo "\`\`\`"
            echo ""
            echo "---"
          } >> evolution/history.md

          git add evolution/history.md
          git commit --amend --no-edit

      - name: Push changes
        if: steps.commit.outputs.has_changes == 'true'
        run: git push

      - name: Summary
        env:
          FEATURE_NAME: ${{ inputs.test_mode == true && steps.test_review.outputs.feature_name || steps.review.outputs.feature_name }}
        run: |
          if [ "${{ inputs.test_mode }}" == "true" ]; then
            echo "## Test Mode - Git Flow Verified!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Push permissions working correctly." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.commit.outputs.has_changes }}" == "true" ]; then
            echo "## Evolution Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Feature:** ${FEATURE_NAME}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Date:** ${{ steps.setup.outputs.date }} ${{ steps.setup.outputs.time }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## No Changes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No new features were implemented in this run." >> $GITHUB_STEP_SUMMARY
          fi
